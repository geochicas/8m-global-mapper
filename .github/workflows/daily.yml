rm -f .github/workflows/daily.yml
mkdir -p .github/workflows

cat > .github/workflows/daily.yml <<'YML'
name: Daily 8M Global Mapper

on:
  push:
    branches: ["main"]
  workflow_dispatch:
  schedule:
    - cron: "0 9 * * *"

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run mapper
        env:
          FAST_MODE: "true"
          MAX_SEEDS: "120"
          MAX_TOTAL_CANDIDATES: "1800"
          MAX_PRIORITY: "600"
          REQUEST_TIMEOUT: "25"
          MIN_EVENT_DATE: "2025-01-01"
          # ENABLE_SOCIAL_SEEDS: "false"  # por defecto ya es false
        run: |
          python main.py

      - name: Prepare site for GitHub Pages
        run: |
          rm -rf site
          mkdir -p site/exports site/images

          # Copia exports (si existen)
          if [ -d "data/exports" ]; then
            cp -r data/exports/* site/exports/ || true
          fi

          # Copia imÃ¡genes (si existen)
          if [ -d "data/images" ]; then
            cp -r data/images/* site/images/ || true
          fi

          # Genera index.html simples
          python - <<'PY'
          import os

          def write_index(dirpath, title):
              os.makedirs(dirpath, exist_ok=True)
              items = sorted(os.listdir(dirpath))
              html = [f"<html><body><h1>{title}</h1><ul>"]
              for it in items:
                  if it == "index.html":
                      continue
                  html.append(f'<li><a href="./{it}">{it}</a></li>')
              html.append("</ul></body></html>")
              with open(os.path.join(dirpath, "index.html"), "w", encoding="utf-8") as f:
                  f.write("\n".join(html))

          write_index("site/exports", "Exports")
          write_index("site/images", "Images")
          PY

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: site

      - name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v4
YML
