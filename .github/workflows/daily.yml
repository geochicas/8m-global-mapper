name: 8M Global Scraper Daily

on:
  schedule:
    - cron: "0 6 * * *"
  workflow_dispatch:
    - main

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      - name: Run scraper
        run: |
          python main.py

      - name: Build static site (exports + images)
        run: |
          rm -rf site
          mkdir -p site/exports site/images

          cp -v data/exports/*.csv site/exports/ || true
          cp -v data/images/*.jpg site/images/ || true
          cp -v data/images/*.jpeg site/images/ || true
          cp -v data/images/*.png site/images/ || true

          cat > site/index.html << 'HTML'
          <html><body>
            <h1>8M Global Mapper</h1>
            <ul>
              <li><a href="./exports/index.html">exports/</a></li>
              <li><a href="./images/index.html">images/</a></li>
            </ul>
          </body></html>
          HTML

          python - << 'PY'
          import os

          def write_index(dirpath, title):
              items = sorted(os.listdir(dirpath))
              html = [f"<html><body><h1>{title}</h1><ul>"]
              for it in items:
                  if it == "index.html":
                      continue
                  html.append(f'<li><a href="./{it}">{it}</a></li>')
              html.append("</ul></body></html>")
              with open(os.path.join(dirpath, "index.html"), "w", encoding="utf-8") as f:
                  f.write("\n".join(html))

          os.makedirs("site/exports", exist_ok=True)
          os.makedirs("site/images", exist_ok=True)
          write_index("site/exports", "Exports")
          write_index("site/images", "Images")
          PY

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: site

      - name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v4
